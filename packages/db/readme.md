# Subtis - DB

## Schema

[Supabase Schema](https://supabase-schema.vercel.app/#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)

## Indexes

- Subtitles
  - bytes
  - title_id
  - title_file_name

- Titles
  - title_name
  - year

## Functions


```sql
CREATE OR REPLACE FUNCTION public.fuzzy_search_title(query text)
RETURNS TABLE (
    id int8,
    imdb_id text,
    title_name text,
    year int8,
    type text,
    slug text,
    optimized_backdrop text,
    optimized_poster text,
    optimized_logo text,
    searched_times int2,
    queried_times int2,
    poster_thumbhash text,
    backdrop_thumbhash text,
    overview text,
    runtime int2,
    rating float4
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        t.id,
        t.imdb_id,
        t.title_name,
        t.year,
        t.type,
        t.slug,
        t.optimized_backdrop,
        t.optimized_poster,
        t.optimized_logo,
        t.searched_times,
        t.queried_times,
        t.poster_thumbhash,
        t.backdrop_thumbhash,
        t.overview,
        t.runtime,
        t.rating
    FROM "Titles" t
    WHERE (
        (unaccent(query) % unaccent(t.title_name) AND similarity(unaccent(query), unaccent(t.title_name)) > 0.7)
        OR (unaccent(query) % unaccent(t.title_name_spa) AND similarity(unaccent(query), unaccent(t.title_name_spa)) > 0.7)
        OR (unaccent(query) % unaccent(t.title_name_ja) AND similarity(unaccent(query), unaccent(t.title_name_ja)) > 0.7)
        OR unaccent(t.title_name) ILIKE '%' || unaccent(query) || '%'
        OR unaccent(t.title_name_spa) ILIKE '%' || unaccent(query) || '%'
        OR unaccent(t.title_name_ja) ILIKE '%' || unaccent(query) || '%'
    )
    ORDER BY t.year DESC;
END;
$$ LANGUAGE plpgsql;
```

```sql
CREATE OR REPLACE FUNCTION update_subtitle_and_title_download_metrics(_imdb_id text, _subtitle_id int8)
RETURNS boolean AS $$
DECLARE
    success boolean;
BEGIN
    UPDATE "Subtitles"
    SET last_queried_at = CURRENT_TIMESTAMP,
        queried_times = queried_times + 1
    WHERE id = _subtitle_id
    RETURNING true INTO success;

    IF success THEN
        UPDATE "Titles"
        SET last_queried_at = CURRENT_TIMESTAMP,
            queried_times = queried_times + 1
        WHERE imdb_id = _imdb_id
        RETURNING true INTO success;
    END IF;

    RETURN COALESCE(success, false);
END;
$$ LANGUAGE plpgsql;
```

```sql
CREATE OR REPLACE FUNCTION update_title_search_metrics(_imdb_id text)
RETURNS boolean AS $$
DECLARE
    success boolean;
BEGIN
    UPDATE "Titles"
    SET last_queried_at = CURRENT_TIMESTAMP,
        searched_times = searched_times + 1
    WHERE imdb_id = _imdb_id
    RETURNING true INTO success;

    RETURN COALESCE(success, false);
END;
$$ LANGUAGE plpgsql;
```
