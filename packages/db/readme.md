# Subtis - DB

## Schema

[Supabase Schema](https://supabase-schema.vercel.app/#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)

## Indexes

- Subtitles
  - bytes
  - title_id
  - title_file_name

- Titles
  - title_name
  - year

## Functions

```sql
CREATE OR REPLACE FUNCTION public.fuzzy_search_title(query text)
RETURNS TABLE (
    id int8,
    imdb_id text,
    title_name text,
    title_name_spa text,
    title_name_ja text,
    year int8,
    type text,
    slug text,
    optimized_backdrop text,
    optimized_poster text,
    optimized_logo text,
    searched_times int2,
    queried_times int2,
    poster_thumbhash text,
    backdrop_thumbhash text,
    overview text,
    runtime int2,
    rating float4,
    youtube_id text,
    certification text
)
SET search_path = 'public'
AS $$
DECLARE
    year_match int8 := NULL;
    title_query text := query;
    year_only_search boolean := false;
BEGIN
    -- Check for year-only query
    IF query ~ '^\d{4}$' THEN
        year_match := CAST(query AS int8);
        year_only_search := true;
    ELSE
        -- Extract potential year from query for matching
        IF query ~ '\d{4}' THEN
            year_match := CAST(substring(query FROM '\d{4}') AS int8);
        END IF;

        -- For "[TITLE] [YEAR]" format (e.g., "Her 2013"), create a modified query without the year
        IF query ~ '.+\s+\d{4}$' THEN
            title_query := regexp_replace(query, '\s+\d{4}$', '', 'g');
        END IF;
    END IF;

    RETURN QUERY
    SELECT
        t.id,
        t.imdb_id,
        t.title_name,
        t.title_name_spa,
        t.title_name_ja,
        t.year,
        t.type,
        t.slug,
        t.optimized_backdrop,
        t.optimized_poster,
        t.optimized_logo,
        t.searched_times,
        t.queried_times,
        t.poster_thumbhash,
        t.backdrop_thumbhash,
        t.overview,
        t.runtime,
        t.rating,
        t.youtube_id,
        t.certification
    FROM public."Titles" t
    WHERE (
        year_only_search OR
        (unaccent(query) % unaccent(t.title_name) AND similarity(unaccent(query), unaccent(t.title_name)) > 0.65)
        OR (unaccent(query) % unaccent(t.title_name_spa) AND similarity(unaccent(query), unaccent(t.title_name_spa)) > 0.65)
        OR (unaccent(query) % unaccent(t.title_name_ja) AND similarity(unaccent(query), unaccent(t.title_name_ja)) > 0.65)
        OR unaccent(t.title_name) ILIKE '%' || unaccent(query) || '%'
        OR unaccent(t.title_name_spa) ILIKE '%' || unaccent(query) || '%'
        OR unaccent(t.title_name_ja) ILIKE '%' || unaccent(query) || '%'
        OR (title_query != query AND (
            (unaccent(title_query) % unaccent(t.title_name) AND similarity(unaccent(title_query), unaccent(t.title_name)) > 0.65)
            OR (unaccent(title_query) % unaccent(t.title_name_spa) AND similarity(unaccent(title_query), unaccent(t.title_name_spa)) > 0.65)
            OR (unaccent(title_query) % unaccent(t.title_name_ja) AND similarity(unaccent(title_query), unaccent(t.title_name_ja)) > 0.65)
            OR unaccent(t.title_name) ILIKE '%' || unaccent(title_query) || '%'
            OR unaccent(t.title_name_spa) ILIKE '%' || unaccent(title_query) || '%'
            OR unaccent(t.title_name_ja) ILIKE '%' || unaccent(title_query) || '%'
        ))
    )
    AND (
        year_match IS NULL
        OR t.year = year_match
        OR t.title_name ILIKE '%' || year_match || '%'
        OR t.title_name_spa ILIKE '%' || year_match || '%'
        OR t.title_name_ja ILIKE '%' || year_match || '%'
    )
    ORDER BY
        CASE WHEN year_match IS NOT NULL AND t.year = year_match THEN 0 ELSE 1 END,
        GREATEST(
            similarity(unaccent(query), unaccent(t.title_name)),
            similarity(unaccent(query), unaccent(t.title_name_spa)),
            similarity(unaccent(query), unaccent(t.title_name_ja))
        ) DESC,
        t.year DESC;
END;
$$ LANGUAGE plpgsql;
```

```sql
CREATE OR REPLACE FUNCTION public.update_subtitle_and_title_download_metrics(
    _title_slug text,
    _subtitle_id int8
)
RETURNS boolean
SET search_path = ''
AS $$
DECLARE
    success boolean;
BEGIN
    UPDATE public."Subtitles"
    SET last_queried_at = CURRENT_TIMESTAMP,
        queried_times = queried_times + 1
    WHERE id = _subtitle_id
    RETURNING true INTO success;

    IF success THEN
        UPDATE public."Titles"
        SET last_queried_at = CURRENT_TIMESTAMP,
            queried_times = queried_times + 1
        WHERE slug = _title_slug
        RETURNING true INTO success;
    END IF;

    RETURN COALESCE(success, false);
END;
$$ LANGUAGE plpgsql;
```

```sql
CREATE OR REPLACE FUNCTION public.update_title_search_metrics(
    _slug text
)
RETURNS boolean
SET search_path = ''
AS $$
DECLARE
    success boolean;
BEGIN
    UPDATE public."Titles"
    SET last_queried_at = CURRENT_TIMESTAMP,
        searched_times = searched_times + 1
    WHERE slug = _slug
    RETURNING true INTO success;

    RETURN COALESCE(success, false);
END;
$$ LANGUAGE plpgsql;
```

```sql
CREATE OR REPLACE FUNCTION public.sum_queried_times()
RETURNS bigint
SET search_path = public
AS $$
    SELECT SUM(s.queried_times) FROM public."Subtitles" s;
$$ LANGUAGE sql;
```

Get mean time to index subtitles

```sql
SELECT
    AVG(time_to_index_in_s) AS mean_time_to_index
FROM
    "Subtitles"
WHERE
    time_to_index_in_s IS NOT NULL;
```

## Schemas

### Genres

```sql
create table public."Genres" (
  id bigint generated by default as identity not null,
  created_at timestamp with time zone not null default now(),
  genre_id bigint not null,
  name text not null,
  constraint Genres_pkey primary key (id),
  constraint Genres_genre_id_key unique (genre_id),
  constraint Genres_name_key unique (name)
) TABLESPACE pg_default;
```

### ReleaseGroups

```sql
create table public."ReleaseGroups" (
  id bigint generated by default as identity not null,
  created_at timestamp with time zone not null default now(),
  release_group_name text not null,
  matches text[] not null,
  is_supported boolean null,
  constraint ReleaseGroups_pkey primary key (id)
) TABLESPACE pg_default;
```

### SubtitleGroups

```sql
create table public."SubtitleGroups" (
  id bigint generated by default as identity not null,
  created_at timestamp with time zone not null default now(),
  subtitle_group_name text not null,
  website text not null,
  constraint SubtitleGroups_pkey primary key (id),
  constraint SubtitleGroups_subtitle_group_name_key unique (subtitle_group_name),
  constraint SubtitleGroups_website_key unique (website)
) TABLESPACE pg_default;
```

### Subtitles

```sql
create table public."Subtitles" (
  id bigint generated by default as identity not null,
  created_at timestamp with time zone not null default now(),
  author text null,
  bytes bigint not null,
  current_episode bigint null,
  current_season bigint null,
  external_id text not null,
  file_extension text not null,
  is_valid boolean not null,
  lang text not null,
  last_queried_at timestamp with time zone null,
  queried_times bigint null default '0'::bigint,
  release_group_id bigint not null,
  resolution text not null,
  reviewed boolean not null,
  rip_type text null,
  subtitle_file_name text not null,
  subtitle_group_id bigint not null,
  subtitle_link text not null,
  time_to_index_in_s bigint not null,
  title_file_name text not null,
  title_slug text not null,
  torrent_id bigint not null,
  uploaded_by text null,
  title_id bigint not null,
  constraint Subtitles_pkey primary key (id),
  constraint Subtitles_release_group_id_fkey foreign KEY (release_group_id) references "ReleaseGroups" (id),
  constraint Subtitles_subtitle_group_id_fkey foreign KEY (subtitle_group_id) references "SubtitleGroups" (id),
  constraint Subtitles_title_id_fkey foreign KEY (title_id) references "Titles" (id),
  constraint Subtitles_torrent_id_fkey foreign KEY (torrent_id) references "Torrents" (id)
) TABLESPACE pg_default;
```

### SubtitlesNotFound

```sql
create table public."SubtitlesNotFound" (
  id bigint generated by default as identity not null,
  created_at timestamp with time zone not null default now(),
  title_file_name text not null,
  bytes bigint not null,
  email text null,
  run_times bigint not null default '0'::bigint,
  constraint SubtitlesNotFound_pkey primary key (id)
) TABLESPACE pg_default;
```

### TitleGenres

```sql
create table public."TitleGenres" (
  id bigint generated by default as identity not null,
  created_at timestamp with time zone not null default now(),
  title_id bigint not null,
  genre_id bigint not null,
  constraint TitleGenres_pkey primary key (id),
  constraint TitleGenres_genre_id_fkey foreign KEY (genre_id) references "Genres" (genre_id),
  constraint TitleGenres_title_id_fkey foreign KEY (title_id) references "Titles" (id)
) TABLESPACE pg_default;

create index IF not exists "TitleGenres_title_id_idx" on public."TitleGenres" using btree (title_id) TABLESPACE pg_default;

create index IF not exists "TitleGenres_genre_id_idx" on public."TitleGenres" using btree (genre_id) TABLESPACE pg_default;
```

### Titles

```sql
create table public."Titles" (
  created_at timestamp with time zone not null default now(),
  year bigint not null,
  rating real not null,
  poster text null,
  type text not null,
  total_seasons bigint null,
  total_episodes bigint null,
  title_name text not null,
  title_name_spa text not null,
  overview text not null,
  backdrop text null,
  release_date date not null,
  logo text null,
  title_name_without_special_chars text not null,
  last_queried_at timestamp without time zone null,
  queried_times smallint null default '0'::smallint,
  searched_times smallint null default '0'::smallint,
  imdb_id text not null,
  id bigint generated by default as identity not null,
  title_name_ja text null,
  poster_thumbhash text null,
  backdrop_thumbhash text null,
  runtime smallint null,
  optimized_poster text null,
  optimized_backdrop text null,
  optimized_logo text null,
  slug text not null,
  youtube_id text null,
  letterboxd_id text null,
  rottentomatoes_id text null,
  justwatch_id text null,
  spotify_id text null,
  certification text null,
  spotify_type text null,
  constraint Titles_pkey primary key (id, slug),
  constraint Titles_id_key unique (id),
  constraint Titles_imdb_id_key unique (imdb_id),
  constraint Titles_slug_key unique (slug),
  constraint Titles_teaser_key unique (youtube_id)
) TABLESPACE pg_default;

create index IF not exists "Titles_title_name_year_idx" on public."Titles" using btree (title_name, year) TABLESPACE pg_default;
```

### Torrents

```sql
create table public."Titles" (
  created_at timestamp with time zone not null default now(),
  year bigint not null,
  rating real not null,
  poster text null,
  type text not null,
  total_seasons bigint null,
  total_episodes bigint null,
  title_name text not null,
  title_name_spa text not null,
  overview text not null,
  backdrop text null,
  release_date date not null,
  logo text null,
  title_name_without_special_chars text not null,
  last_queried_at timestamp without time zone null,
  queried_times smallint null default '0'::smallint,
  searched_times smallint null default '0'::smallint,
  imdb_id text not null,
  id bigint generated by default as identity not null,
  title_name_ja text null,
  poster_thumbhash text null,
  backdrop_thumbhash text null,
  runtime smallint null,
  optimized_poster text null,
  optimized_backdrop text null,
  optimized_logo text null,
  slug text not null,
  youtube_id text null,
  letterboxd_id text null,
  rottentomatoes_id text null,
  justwatch_id text null,
  spotify_id text null,
  certification text null,
  spotify_type text null,
  constraint Titles_pkey primary key (id, slug),
  constraint Titles_id_key unique (id),
  constraint Titles_imdb_id_key unique (imdb_id),
  constraint Titles_slug_key unique (slug),
  constraint Titles_teaser_key unique (youtube_id)
) TABLESPACE pg_default;

create index IF not exists "Titles_title_name_year_idx" on public."Titles" using btree (title_name, year) TABLESPACE pg_default;
```
